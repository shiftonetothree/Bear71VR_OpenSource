<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, shrink-to-fit=0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-navbutton-color" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style" content="#000000">
  <meta name="medium" content="multi"/>
  <meta name="title" content="NFB/Interactive - Bear 71 VR"/>
  <meta name="description" content="Constant video surveillance, satellite tracking, radio collars… sometimes it’s hard to tell where the wired world ends and the wild one begins - Bear 71"/>
  <meta name="keywords" content="bear71, bear 71, nfb, bear documentary, national film board of canada, webvr"/>
  <link rel="image_src" href="http://interactive.nfb.ca/screens/fb/bear71_FB.jpg" />
  <link rel="target_url" href="http://bear71vr.nfb.ca"/>

  <meta property="og:url"                content="https://bear71vr.nfb.ca/" />
  <meta property="og:title"              content="Bear 71 VR" />
  <meta property="og:description"        content="Explore the intersection of humans, nature and technology in the interactive documentary Bear 71. Questioning how we see the world through the lens of technology, this story blurs the lines between the wild world, and the wired one. nfb.ca/bear71vr" />
  <meta property="og:image"              content="https://bear71vr.nfb.ca/assets/images/bear71-sharing-thumbnail.jpg" />
  <meta property="twitter:url"                content="https://bear71vr.nfb.ca/" />
  <meta property="twitter:title"              content="Bear 71 VR" />
  <meta property="twitter:description"        content="Explore the intersection of humans, nature and technology - blur the lines between the wild world, and the wired one. nfb.ca/bear71vr" />
  <meta property="twitter:image"              content="https://bear71vr.nfb.ca/assets/images/bear-71-sharing-thumbnail.jpg" />

  <!-- Origin Trial Token, feature = WebVR, origin = https://b71.jam3.net, expires = 2017-03-31-->
  <meta http-equiv="origin-trial" data-feature="WebVR" data-expires="2017-03-31" content="Aj7etICAomqPbtO0aeyUOAko/Ze9QYngzDIkHcnwLTBh7thU4l8DvIpHJZov8KkIxJhHQPgGcYmdB4fot/GWIgkAAABLeyJvcmlnaW4iOiJodHRwczovL2I3MS5qYW0zLm5ldDo0NDMiLCJmZWF0dXJlIjoiV2ViVlIiLCJleHBpcnkiOjE0OTA5NzMwNTh9" />
  <title>NFB/Interactive - Bear 71 VR</title>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/style.css" type="text/css">
  <script>
  window.__isNativeWebVRAvailable = 'getVRDisplays' in navigator;
  window.WebVRConfig = {
    TOUCH_PANNER_DISABLED: true,
    ROTATE_INSTRUCTIONS_DISABLED: true,
    CARDBOARD_UI_DISABLED: true,
    BUFFER_SCALE: 1,
    ENABLE_DEPRECATED_API: false,
    FORCE_ENABLE_VR: true
  };
  </script>
</head>
<body>
  <canvas id="canvas" style="width: 100%;height: 100%;"></canvas>
  <div id="minimap" style="width: 128px;height: 128px;border: 1px solid red;position: absolute;">
    <div id="location" style="width: 10px;height: 10px;position: absolute;background-color: white;color:red;font-size: 10px;line-height: 10px;text-align: center;">A</div>
  </div>
  <div style="position: absolute;right: 0;">
    <button onclick="init()">init</button>
    <button onclick="destroy()">destroy</button>
    <button onclick="testMemory()">test memory 10 times</button>
    <button onclick="up()">up</button>
    <button onclick="down()">down</button>
    <button onclick="to()">to</button>
    <button onclick="changeSpritesheet()">changeSpritesheet</button>
  </div>
  <script src="bundle.js"></script>
  <script>
    const names = [
      "可持续发展试验示范区",
      "旅游示范县",
      "农业产业化省级重点龙头企业",
      "农业产业强镇建设",
      "农业科技创新能力条件建设项目",
      "区域生态循环农业项目",
      "省级现代农业产业园",
      "数字农业建设试点项目",
      "文化遗产",
      "物联网",
      "休闲农业三星以上",
      "玉米繁育推一体化示范项目",
      "综合开发区域生态循环农业项目",
      "最美休闲乡",
    ];

    function onMove(x, y, rotate){
      const location = document.getElementById("location");
      location.style.left = x * 100 + "%";
      location.style.top = y * 100 + "%";
      location.style.transform = `rotateZ(${(rotate/Math.PI)*180}deg)`;
    }
    

    const locations = names.map((name)=>{

      const x = (Math.random() - 0.5) * 64 + 50;
      const z = (Math.random() - 0.5) * 64 + 50;
      return {
          "model": `assets/images/${name}.gltf`,
          "position": [x, 0, z],
          "scale": [0.05,0.05,0.05],
          "key": name,
          "name": name,
          "category": name,
          "namePosition": [0,15,0],
          "g": 96,
          onclick:()=>{
            alert(name);
          }
      };
    });
    
    var destroyMap;
    var settings;
    var map;
    function init(){
      console.log("init");
      window.Bear71VR_OpenSource.init(
        window.document.getElementById("canvas"),
        {
          locations: locations,
          carLikes: locations.slice(0,2),
          carLikeG: {96: "road", 104: "railway"},
          userFootHeight: 2.4 * 12,
          mapSize: 32 * 8,
          cursorMaxHitDistance: 11 * 20,
          metersPerSecond: 2.1 * 20,
          onMove: onMove,
          showAxesHelper: true,
        },
        (destroyMapIn, settingsIn, mapIn)=>{
          settings = settingsIn;
          destroyMap = destroyMapIn;
          map = mapIn;
          setHighlight();
          map.updateSectionOffset(0.03);
        }
      );
    }
    init();
    function destroy(){
      console.log("destroy");
      destroyMap();
      destroyMap = null;
      settings = null;
      map = null;
    }
    function setHighlight () {
      const list = map.locations.filter(function (object) {
        return object.category !== "最美休闲乡";
      })
      console.log(list);
      list.map(item => {
        // item.visible = false;
      })
      
    }
    function testMemory(){
      // memory leak test
      let testCount = 10;
      function cycle10(){
        console.log("last "+testCount+" times test")
        window.Bear71VR_OpenSource.init(
          window.document.getElementById("canvas"),
          {
            locations: locations,
            carLikes: locations.slice(0,2),
            carLikeG: {96: "road", 104: "railway"},
          },
          (destroyMap, settingsIn, mapIn)=>{
            settings = settingsIn;
            map = mapIn;
            destroyMap();
            testCount = testCount - 1;
            if(testCount > 0){
              cycle10();
            }else{
              console.log("test finish");
            }
          }
        );
      }

      cycle10();
    }

    function up(){
      map.cameraChangeHeight(88, 2);
      const target = {x: 63.343507344494455, y: 5.413562029627785, z: 55.30752122869849};
      setTimeout(function () {
        map.rotateCamera(target, 3);
      }, 2000);
      // settings.userFootHeight = 2.4 * 12;
      settings.mapSize = 32 * 8;
      settings.cursorMaxHitDistance = 11 * 20;
      settings.metersPerSecond = 2.1 * 20;
      settings.groundPlaneOffset = -1;
      map.updateSectionOffset(0.02);
    }

    function down(){
      map.cameraChangeHeight(2.4, 2);
      settings.mapSize = 32 * 8;
      settings.cursorMaxHitDistance = 11 * 1;
      settings.metersPerSecond = 2.1 * 0.2;
      settings.groundPlaneOffset = 0;
      map.updateSectionOffset(0);
    }

    function to(){
     // map.rotateCamera({x: 0, y: 0, z: 0});
     const list = map.locations.map(function (object) { return object.position}).filter(item => item.x !== undefined);
      console.log("posiitonssss", list, locations);
      map.moveAndRotateCamera(list[0], 10);
      setTimeout(function () {
        map.moveAndRotateCamera(list[1], 10);
      }, 10000)
      setTimeout(function () {
        map.moveAndRotateCamera(list[2], 10);
      }, 30000)
      
      
      // map.moveAndRotateCamera(list[3], undefined); 
      // map.rotateCamera(list[0], 3);
      // // map.moveCamera([list[8].x, list[8].z], 3);
      // setTimeout(function(){
      //   map.moveCamera([list[0].x, list[0].z], 3);
      // }, 3000);
      // setTimeout(function(){
      //   map.rotateCamera(list[6], 3);
      // }, 6000);
      // setTimeout(function(){
      //   map.moveCamera([list[6].x, list[6].z], 3);
      // }, 9000);
    }

    function changeSpritesheet(){
      map.changeSpritesheet(`assets/images/spritesheet.png`);
    }
    
    
  </script>
</body>
</html>